{% extends "base.html" %}

{% block title %}
    Sales Applications: Record Sale
{% endblock %}

{% block header %}
    Record Sale
{% endblock %}

{% block extrahead %}
     <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
     <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/calendar.css" />
     <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
     <script type="text/javascript" src="{{ STATIC_URL }}js/accounting.min.js"></script>
     <script type="text/javascript" src="{{ STATIC_URL }}js/utils.js"></script>

     <script type="text/javascript">
        $(document).ready(function() {
            // Set up the calculator icon
            $("#calculator").click(function() {
                if ($("#id_item").val() == "")
                {
                    warning("An item must be chosen before auto calculating the discount");
                }
                else
                {
                    $("#id_sale_price").val("");   // Remove any previous value
                    popup("#discount-form", "Auto Calculate Discount", "Auto Calculate",
                        calculate_discount, calculator_validation);
                }
            });

            // Set up the jQuery datepicker with the calendar icon
            $("#datepicker").datepicker({
                buttonImage: '{{ STATIC_URL }}admin/img/icon_calendar.gif',
                buttonImageOnly: true,
                buttonText: 'Click to show the calendar',
                altField: "#id_date",
                changeMonth: true,
                changeYear: true,
                showOn: 'both',
                showButtonPanel: true
             });

            // Update the calculated sales price when any of these
            // related things change
            $("#id_item").change(update_sales_values);
            $("#id_tax_rate").change(update_sales_values);
            $("#id_discount").change(update_sales_values);
        });

        // Calculate the discount based on what the item originally was selling for compared to the actual selling price
        function calculate_discount()
        {
            // #item_price will always have the original price, #id_price get's updated so we can't use that
            var price = accounting.unformat($("#item_price").text());
            var discount = (price - $("#id_sale_price").val())/price * 100.0;
            discount = accounting.toFixed(discount, 2);     // Round to 2 significant digits

            $("#id_discount").val(discount);
            $("#id_price").val($("#id_sale_price").val());
        }

        // Validate that the sale price entered when clicking the calculator icon is a valid positive number
        function calculator_validation()
        {
            if ($("#id_sale_price").val() == "")
            {
                warning("No sale price given");
                return false;
            }
            else if (validatePositiveDecimal($("#id_sale_price").val()) == false)
            {
                warning("Sale price is an illegal value");
                return false;
            }
            else
            {
                return true;
            }
        }

        // Clean up the form to make it ready for submission
        function cleanForm()
        {
            // If 'commission' is set to "N/A", change to an empty string so Django validation works
            if ($("#id_commission").val() == "N/A") $("#id_commission").val("");

            return true;
        }

        // Update the fields as a convenience when something related changed
        function update_sales_values()
        {
            if ($("#id_item").val() != "")
            {
                if ($("#id_tax_rate").val() != "")
                {
                    if ($("#id_discount").val() == "")
                    {
                        // Change discount to 0 if not set
                        $("#id_discount").val(0);
                    }

                    $.get(
                        "/shopowner/sales/update_values/",
                        {
                            "discount": $("#id_discount").val(),
                            "item":     $("#id_item").val(),
                            "tax_rate": $("#id_tax_rate").val()
                        },
                        function(data) {
                            $("#id_commission").val(data.commission);
                            $("#id_price").val(data.price);
                            $("#item_price").text(accounting.formatMoney(data.price));
                        }
                    )
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        // Show Django error page so we can easily see the error
                        error_page(jqXHR, textStatus, errorThrown);
                    });
                }
                else
                {
                    warning("Can't automatically calculate price or commission without the tax rate.");
                }
            }
            else
            {
                $("#id_commission").val("");
                $("#id_price").val("");
                $("#item_price").text("");
            }
        }
    </script>
{% endblock %}

{% block content %}
    {% include "messages.html" %}

    <p>
        Enter the details as required, then press <strong>Record</strong> to save
        the information.  Clicking on the calendar icon next to the <em>Date</em> field will bring up a date picker.
        The <em>Price</em> and <em>Commission</em> will be filled out automatically based on
        the item sold and the tax rate.
    </p>

    {% if form.errors %}
        <p class="errornote">
            Please correct the errors below.
        </p>

        <br />
    {% endif %}

    <form method="post" onsubmit="return cleanForm();">
        {% csrf_token %}

        <table>
            {{ form.as_table }}
        </table>

        {% include "form_buttons.html" with submit_name="Record" %}
    </form>

    <div id="discount-form" style="display: none;">
        <p>
            The currently selected item is listed to sell for <span id="item_price"></span> (includes sales tax).
            Please enter the actual sale price (including sales tax) below.
        </p>

        $<input id="id_sale_price" type="text" />
    </div>
{% endblock %}

