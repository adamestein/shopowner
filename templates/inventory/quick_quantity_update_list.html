{% extends "inventory/_inventory_list.html" %}
{% load static %}

{% block ready_js %}
    let csrftoken = Cookies.get('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function csrfSafeMethod(method) {
        // These HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    inventoryTable.MakeCellsEditable({
        "allowNulls": {
            "columns": []
        },
        "columns": [3, 4],
        "confirmationButton": {
            "confirmCss": "btn btn-success btn-sm",
            "cancelCss": "btn btn-danger btn-sm",
            "listenToKeys": true
        },
        "inputTypes": [
            {
                "column": 3,
                "type": "number"
            },
            {
                "column": 4,
                "type": "number"
            }
        ],
        "onUpdate": storeUpdatedValue,
        "onValidate": validateUpdatedValue
    });
{% endblock %}

{% block js %}
    {{ block.super }}

    <script type="text/javascript" src="{% static 'js/js.cookie.js' %}"></script>
    <script type="text/javascript" src="{% static "js/dataTables.cellEdit.js" %}"></script>

    <script>
        function storeUpdatedValue(updatedCell, updatedRow, oldValue) {
            if (updatedCell.data() !== oldValue) {
                let field = (updatedCell.index()["column"] === 3) ? "qty_bought" : "qty_sold";

                $.post(
                    "{% url "inventory:save_quantity_values" %}",
                    {
                        "field": field,
                        "item_id": updatedRow.nodes().to$().data("id"),
                        "new_value": updatedCell.data()
                    }
                ).fail(function(jqXHR, textStatus, errorThrown) {
                    alert(
                        "Could not save quantity information.\n\nError: " + jqXHR.responseText
                    );
                });
            }
        }

        function validateUpdatedValue(cell, row, newValue) {
            return !isNaN(newValue);
        }
    </script>
{% endblock %}

{% block header %}Quick Quantity Update{% endblock %}

{% block xdata_table_handler %}
    $("#item_label").html(inventoryTable.row(this).data()[0]);

    $.get(
        "{% url "inventory:fetch_quantities" %}",
        {"item_id": $(this).data("id")},
        function(response) {
            let values = JSON.parse(response);
            console.log('Values = [' + Dumper(values) + ']');

            let html = `
                <form class="form-horizontal" role="form">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="id_qty_bought">Quantity Bought</label>

                        <div class="col-sm-10">
                            <input id="id_qty_bought" class="form-control" type="number" name="qty_bought" value="${values['qty_bought']}" style="display: inline !important" required="">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="id_qty_sold">Quantity Sold</label>

                        <div class="col-sm-10">
                            <input id="id_qty_sold" class="form-control" type="number" name="qty_sold" value="${values['qty_sold']}" style="display: inline !important" required="">
                        </div>
                    </div>
                </form>
            `;

            $(".modal-body").empty().append(html);

            new bootstrap.Modal(document.getElementById("quantities")).show();
        }
    ).fail(function(jqXHR, textStatus, errorThrown) {
        alert(
            "Could not fetch quantity information.\n\nError: " + jqXHR.responseText
        );
        // $("body").removeClass("busy");
    });
{% endblock %}

{% block instructions %}
    <p>Click on an item's row to quickly update that item's quanity bought and sold values.</p>
{% endblock %}

{% block extra_content %}
    <div class="modal fade" id="quantities" tabindex="-1" aria-labelledby="quantitiesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quantitiesLabel">Bought/Sold Quantities for <span id="item_label"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body"></div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
